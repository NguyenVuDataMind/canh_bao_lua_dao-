<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - SafeNet Hub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #041b2f;
            --bg-gradient-start: #052640;
            --bg-gradient-end: #01212f;
            --primary: #00c16a;
            --secondary: #00b0ff;
            --accent: #ff695a;
            --text: #e4f1ff;
            --text-muted: rgba(228, 241, 255, 0.72);
            --card-bg: rgba(8, 27, 48, 0.8);
            --border: rgba(255, 255, 255, 0.08);
            --shadow: 0 30px 60px rgba(0, 0, 0, 0.45);
            --radius-lg: 28px;
            --radius-md: 20px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Be Vietnam Pro', 'Segoe UI', Tahoma, sans-serif;
            background: radial-gradient(circle at 20% 20%, #07355c, #031525);
            color: var(--text);
            min-height: 100vh;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .admin-header h1 {
            margin: 0;
            font-size: 32px;
            color: var(--primary);
        }

        .back-btn {
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 12px 24px;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .reports-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .report-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 24px;
            box-shadow: var(--shadow);
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }

        .report-id {
            font-size: 14px;
            color: var(--text-muted);
        }

        .report-date {
            font-size: 14px;
            color: var(--text-muted);
        }

        .report-content {
            margin-bottom: 20px;
        }

        .report-content p {
            margin: 8px 0;
        }

        .report-content strong {
            color: var(--primary);
        }

        .report-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }

        .btn-danger {
            background: var(--accent);
            color: white;
        }

        .btn-danger:hover {
            background: #ff4d3a;
            transform: translateY(-2px);
        }

        .btn-safe {
            background: var(--primary);
            color: #042818;
        }

        .btn-safe:hover {
            background: #00d97a;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state h2 {
            margin: 0 0 10px;
            color: var(--text);
        }

        .error-message {
            background: rgba(255, 105, 90, 0.2);
            border: 1px solid var(--accent);
            color: var(--accent);
            padding: 16px;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>üîí Admin Panel</h1>
            <button class="back-btn" onclick="window.location.href='/index.html'">‚Üê Quay l·∫°i</button>
        </div>

        <!-- Tabs ƒë·ªÉ chuy·ªÉn ƒë·ªïi gi·ªØa Reports v√† SOS -->
        <div class="admin-tabs" style="display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid var(--border);">
            <button class="admin-tab active" onclick="switchTab('reports')" style="padding: 12px 24px; background: transparent; border: none; border-bottom: 2px solid var(--primary); color: var(--primary); cursor: pointer; font-weight: 600;">
                üìã B√°o c√°o
            </button>
            <button class="admin-tab" onclick="switchTab('sos')" style="padding: 12px 24px; background: transparent; border: none; border-bottom: 2px solid transparent; color: var(--text-muted); cursor: pointer; font-weight: 600;">
                üö® SOS Requests
            </button>
        </div>

        <div id="errorMessage" style="display: none;"></div>
        
        <!-- Reports Tab -->
        <div id="reportsTab" class="tab-content">
            <div id="reportsList" class="reports-list">
                <div class="loading">ƒêang t·∫£i danh s√°ch b√°o c√°o...</div>
            </div>
        </div>

        <!-- SOS Requests Tab -->
        <div id="sosTab" class="tab-content" style="display: none;">
            <div id="sosList" class="reports-list">
                <div class="loading">ƒêang t·∫£i danh s√°ch SOS requests...</div>
            </div>
        </div>
    </div>

    <script>
        let adminPassword = null;

        // Ki·ªÉm tra password khi load trang
        function checkPassword() {
            const stored = sessionStorage.getItem('admin_password');
            if (stored === 'chongluadaotmdt') {
                adminPassword = stored;
                loadReports();
            } else {
                const password = prompt('Nh·∫≠p m·∫≠t kh·∫©u admin:');
                if (password === 'chongluadaotmdt') {
                    adminPassword = password;
                    sessionStorage.setItem('admin_password', password);
                    loadReports();
                } else {
                    alert('M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!');
                    window.location.href = '/index.html';
                }
            }
        }

        async function loadSOSRequests() {
            const sosList = document.getElementById('sosList');
            const errorMessage = document.getElementById('errorMessage');
            
            try {
                const response = await fetch('/api/v1/sos?limit=50');
                if (!response.ok) {
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i danh s√°ch SOS requests');
                }
                
                const sosRequests = await response.json();
                
                if (sosRequests.length === 0) {
                    sosList.innerHTML = `
                        <div class="empty-state">
                            <h2>‚úÖ Kh√¥ng c√≥ SOS request n√†o</h2>
                            <p>Ch∆∞a c√≥ y√™u c·∫ßu c·∫ßu c·ª©u n√†o ƒë∆∞·ª£c g·ª≠i.</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                sosRequests.forEach(sos => {
                    const sosDate = new Date(sos.created).toLocaleString('vi-VN');
                    const mapsUrl = sos.latitude && sos.longitude 
                        ? `https://www.google.com/maps?q=${sos.latitude},${sos.longitude}`
                        : '#';
                    const statusBadge = sos.status === 'pending' 
                        ? '<span style="background: #ff695a; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">‚è≥ Ch·ªù x·ª≠ l√Ω</span>'
                        : sos.status === 'responded'
                        ? '<span style="background: #00b0ff; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">üìû ƒê√£ ph·∫£n h·ªìi</span>'
                        : '<span style="background: #00c16a; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">‚úÖ ƒê√£ x·ª≠ l√Ω</span>';
                    
                    html += `
                        <div class="report-card" data-sos-id="${sos.id}">
                            <div class="report-header">
                                <span class="report-id">üö® SOS #${sos.id}</span>
                                <span class="report-date">${sosDate}</span>
                            </div>
                            <div class="report-content">
                                ${sos.latitude && sos.longitude ? `
                                    <p><strong>üìç V·ªã tr√≠:</strong></p>
                                    <ul style="list-style: none; padding: 0; margin: 8px 0;">
                                        <li>Latitude: <code style="background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px;">${sos.latitude}</code></li>
                                        <li>Longitude: <code style="background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px;">${sos.longitude}</code></li>
                                        ${sos.accuracy ? `<li>ƒê·ªô ch√≠nh x√°c: ${sos.accuracy.toFixed(0)} m√©t</li>` : ''}
                                    </ul>
                                    <p style="margin-top: 12px;">
                                        <a href="${mapsUrl}" target="_blank" style="background: var(--primary); color: #042818; padding: 8px 16px; text-decoration: none; border-radius: 8px; display: inline-block; font-weight: 600;">
                                            üìç Xem tr√™n Google Maps
                                        </a>
                                    </p>
                                ` : '<p style="color: var(--text-muted);">‚ö†Ô∏è Kh√¥ng c√≥ th√¥ng tin v·ªã tr√≠</p>'}
                                ${sos.ip_address ? `<p><strong>IP Address:</strong> ${sos.ip_address}</p>` : ''}
                                ${sos.user_agent ? `<p><strong>User Agent:</strong> <small style="color: var(--text-muted);">${sos.user_agent}</small></p>` : ''}
                                <p style="margin-top: 12px;"><strong>Tr·∫°ng th√°i:</strong> ${statusBadge}</p>
                                ${sos.notes ? `<p style="margin-top: 8px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;"><strong>Ghi ch√∫:</strong> ${sos.notes}</p>` : ''}
                            </div>
                            <div class="report-actions">
                                <button class="btn btn-danger" onclick="updateSOSStatus(${sos.id}, 'responded')" ${sos.status !== 'pending' ? 'disabled' : ''}>
                                    üìû ƒê√£ ph·∫£n h·ªìi
                                </button>
                                <button class="btn btn-safe" onclick="updateSOSStatus(${sos.id}, 'resolved')" ${sos.status === 'resolved' ? 'disabled' : ''}>
                                    ‚úÖ ƒê√£ x·ª≠ l√Ω
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                sosList.innerHTML = html;
            } catch (error) {
                errorMessage.style.display = 'block';
                errorMessage.innerHTML = `<strong>L·ªói:</strong> ${error.message}`;
                sosList.innerHTML = '';
            }
        }

        async function updateSOSStatus(sosId, status) {
            const statusText = status === 'responded' ? 'ƒê√£ ph·∫£n h·ªìi' : 'ƒê√£ x·ª≠ l√Ω';
            if (!confirm(`X√°c nh·∫≠n: ƒê√°nh d·∫•u SOS request n√†y l√† "${statusText}"?`)) {
                return;
            }

            const card = document.querySelector(`[data-sos-id="${sosId}"]`);
            const buttons = card.querySelectorAll('.btn');
            buttons.forEach(btn => btn.disabled = true);

            try {
                const response = await fetch(`/api/v1/sos/${sosId}/status?status=${status}`, {
                    method: 'PATCH',
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i');
                }
                
                // Reload danh s√°ch
                loadSOSRequests();
            } catch (error) {
                alert('‚ùå L·ªói: ' + error.message);
                buttons.forEach(btn => btn.disabled = false);
            }
        }

        function switchTab(tab) {
            // ·∫®n t·∫•t c·∫£ tabs
            document.getElementById('reportsTab').style.display = 'none';
            document.getElementById('sosTab').style.display = 'none';
            
            // X√≥a active class t·ª´ t·∫•t c·∫£ buttons
            document.querySelectorAll('.admin-tab').forEach(btn => {
                btn.classList.remove('active');
                btn.style.borderBottomColor = 'transparent';
                btn.style.color = 'var(--text-muted)';
            });
            
            // Hi·ªÉn th·ªã tab ƒë∆∞·ª£c ch·ªçn
            if (tab === 'reports') {
                document.getElementById('reportsTab').style.display = 'block';
                document.querySelectorAll('.admin-tab')[0].classList.add('active');
                document.querySelectorAll('.admin-tab')[0].style.borderBottomColor = 'var(--primary)';
                document.querySelectorAll('.admin-tab')[0].style.color = 'var(--primary)';
                loadReports();
            } else if (tab === 'sos') {
                document.getElementById('sosTab').style.display = 'block';
                document.querySelectorAll('.admin-tab')[1].classList.add('active');
                document.querySelectorAll('.admin-tab')[1].style.borderBottomColor = 'var(--primary)';
                document.querySelectorAll('.admin-tab')[1].style.color = 'var(--primary)';
                loadSOSRequests();
            }
        }

        async function loadReports() {
            const reportsList = document.getElementById('reportsList');
            const errorMessage = document.getElementById('errorMessage');
            
            try {
                const response = await fetch(`/api/v1/admin/pending-reports?password=${encodeURIComponent(adminPassword)}`);
                if (!response.ok) {
                    if (response.status === 401) {
                        sessionStorage.removeItem('admin_password');
                        alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                        window.location.href = '/index.html';
                        return;
                    }
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i danh s√°ch b√°o c√°o');
                }
                
                const reports = await response.json();
                
                if (reports.length === 0) {
                    reportsList.innerHTML = `
                        <div class="empty-state">
                            <h2>‚úÖ Kh√¥ng c√≥ b√°o c√°o n√†o ch·ªù duy·ªát</h2>
                            <p>T·∫•t c·∫£ b√°o c√°o ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω.</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                reports.forEach(report => {
                    const reportType = report.reported_url ? 'URL' : report.reported_phone ? 'SƒêT' : 'Email';
                    const reportValue = report.reported_url || report.reported_phone || report.reported_email || 'N/A';
                    const reportDate = new Date(report.created).toLocaleString('vi-VN');
                    
                    html += `
                        <div class="report-card" data-report-id="${report.id}">
                            <div class="report-header">
                                <span class="report-id">ID: #${report.id}</span>
                                <span class="report-date">${reportDate}</span>
                            </div>
                            <div class="report-content">
                                <p><strong>Lo·∫°i:</strong> ${reportType}</p>
                                <p><strong>Gi√° tr·ªã:</strong> <code style="background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px;">${reportValue}</code></p>
                                ${report.description ? `<p><strong>M√¥ t·∫£:</strong> ${report.description}</p>` : ''}
                                ${report.source ? `<p><strong>Ngu·ªìn:</strong> ${report.source}</p>` : ''}
                            </div>
                            <div class="report-actions">
                                <button class="btn btn-danger" onclick="approveReport(${report.id}, '${reportType}')">
                                    ‚ö†Ô∏è L·ª´a ƒë·∫£o
                                </button>
                                <button class="btn btn-safe" onclick="rejectReport(${report.id})">
                                    ‚úÖ Kh√¥ng ph·∫£i
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                reportsList.innerHTML = html;
            } catch (error) {
                errorMessage.style.display = 'block';
                errorMessage.innerHTML = `<strong>L·ªói:</strong> ${error.message}`;
                reportsList.innerHTML = '';
            }
        }

        async function approveReport(reportId, reportType) {
            if (!confirm(`X√°c nh·∫≠n: B√°o c√°o n√†y l√† L·ª™A ƒê·∫¢O v√† s·∫Ω ƒë∆∞·ª£c th√™m v√†o blacklist?`)) {
                return;
            }

            const card = document.querySelector(`[data-report-id="${reportId}"]`);
            const buttons = card.querySelectorAll('.btn');
            buttons.forEach(btn => btn.disabled = true);

            try {
                const endpoint = reportType === 'URL' 
                    ? `/api/v1/admin/approve-report/${reportId}/url`
                    : `/api/v1/admin/approve-report/${reportId}/phone`;
                
                const response = await fetch(`${endpoint}?password=${encodeURIComponent(adminPassword)}`, {
                    method: 'POST',
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Kh√¥ng th·ªÉ duy·ªát b√°o c√°o');
                }
                
                // X√≥a card kh·ªèi danh s√°ch
                card.style.opacity = '0.5';
                card.style.transition = 'opacity 0.3s';
                setTimeout(() => {
                    card.remove();
                    // Reload n·∫øu kh√¥ng c√≤n report n√†o
                    const remaining = document.querySelectorAll('.report-card').length;
                    if (remaining === 0) {
                        loadReports();
                    }
                }, 300);
            } catch (error) {
                alert('‚ùå L·ªói: ' + error.message);
                buttons.forEach(btn => btn.disabled = false);
            }
        }

        async function rejectReport(reportId) {
            if (!confirm(`X√°c nh·∫≠n: B√°o c√°o n√†y KH√îNG PH·∫¢I l·ª´a ƒë·∫£o v√† s·∫Ω ƒë∆∞·ª£c ƒë√°nh d·∫•u ƒë√£ duy·ªát?`)) {
                return;
            }

            const card = document.querySelector(`[data-report-id="${reportId}"]`);
            const buttons = card.querySelectorAll('.btn');
            buttons.forEach(btn => btn.disabled = true);

            try {
                const response = await fetch(`/api/v1/admin/reject-report/${reportId}?password=${encodeURIComponent(adminPassword)}`, {
                    method: 'POST',
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.detail || 'Kh√¥ng th·ªÉ ƒë√°nh d·∫•u b√°o c√°o');
                }
                
                // X√≥a card kh·ªèi danh s√°ch
                card.style.opacity = '0.5';
                card.style.transition = 'opacity 0.3s';
                setTimeout(() => {
                    card.remove();
                    // Reload n·∫øu kh√¥ng c√≤n report n√†o
                    const remaining = document.querySelectorAll('.report-card').length;
                    if (remaining === 0) {
                        loadReports();
                    }
                }, 300);
            } catch (error) {
                alert('‚ùå L·ªói: ' + error.message);
                buttons.forEach(btn => btn.disabled = false);
            }
        }

        // Load khi trang ƒë∆∞·ª£c m·ªü
        checkPassword();
    </script>
</body>
</html>

